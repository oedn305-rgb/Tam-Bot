import os
import requests
import random

def safe_tam_bot():
    openai_key = os.getenv('OPENAI_API_KEY')
    api_key = os.getenv('API_KEY')
    blog_id = os.getenv('BLOG_ID')

    # قطاعات منوعة لاستهداف بحث حراج ومستعمل
    sectors = ["السيارات المستعملة", "العقارات السكنية", "الجوالات والأجهزة", "الخدمات المنزلية"]
    target = random.choice(sectors)

    # أمر (Prompt) احترافي يضمن محتوى حصري 100%
    prompt = (
        f"أنت خبير محتوى تسويقي. اكتب مقالاً حصرياً لمدونة 'تم السعودية' بعنوان: 'دليل شامل حول أسعار {target} في السوق السعودي لهذا الشهر'.\n"
        "المطلوب لضمان قبول أدسنس:\n"
        "1. ابدأ بمقدمة تتحدث عن حالة السوق حالياً.\n"
        "2. قارن بين العروض القديمة والجديدة (بدون نسخ أرقام جوالات أو أسماء معلنين).\n"
        "3. أضف قسم: 'نصيحة خبراء تم السعودية للمشترين'.\n"
        "4. استخدم كلمات مفتاحية طبيعية (SEO) غير مكررة بشكل مزعج.\n"
        "5. اجعل الخاتمة تدعو القارئ لمشاركة رأيه في التعليقات.\n"
        "التنسيق: HTML احترافي بفقرات واضحة."
    )

    headers = {"Authorization": f"Bearer {openai_key}", "Content-Type": "application/json"}
    data = {
        "model": "gpt-3.5-turbo", # يمكنك ترقيته لـ gpt-4 لمحتوى أكثر عمقاً
        "messages": [{"role": "user", "content": prompt}],
        "temperature": 0.6 # درجة حرارة منخفضة لضمان عقلانية النص وعدم التكرار
    }

    try:
        response = requests.post("https://api.openai.com/v1/chat/completions", headers=headers, json=data)
        content = response.json()['choices'][0]['message']['content']

        # تجهيز المقال للنشر
        lines = content.strip().split('\n')
        title = lines[0].replace("#", "").strip()
        body = "".join(lines[1:]).replace("\n", "<br>")

        # النشر عبر Blogger API
        url = f"https://www.googleapis.com/blogger/v3/blogs/{blog_id}/posts/?key={api_key}"
        payload = {"kind": "blogger#post", "title": title, "content": body}
        
        publish = requests.post(url, json=payload)
        if publish.status_code == 200:
            print(f"✅ تم نشر مقال آمن وحصري عن: {target}")
        else:
            print(f"❌ خطأ: {publish.text}")

    except Exception as e:
        print(f"❌ حدث خطأ: {e}")

if __name__ == "__main__":
    safe_tam_bot()
